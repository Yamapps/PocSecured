# Android POC Secured

This is the repository for the Android secured POC. 

This demo shows how to build a simple Android app that integrates the Microsoft Authenthication Library (MSAL).


## MSAL Integration

Here are the steps to integrate the MSAL library into your Android app.

### Register App to Azure Portal

The first step is to register your app to your company's Azure Portal. Here is a link to the Microsoft tutorial that details the necessary actions to register an app :

[Link to Microsoft tutorial](https://docs.microsoft.com/en-us/azure/active-directory/develop/tutorial-v2-android)

### Add MSAL configuration file

After registering your app to the Azure Portal, a config specific json file should have been generated by the Azure Portal and displayed.
<br/>It should look like this : 

```json
    {
        "client_id": "6f483c01-4f04-4393-89ef-b07939462101",
        "authorization_user_agent": "DEFAULT",
        "redirect_uri": "msauth://com.amf.pocsecured/q%2BPiRqOdRzucqQyP%2FOcnNoHD5tg%3D",
        "authorities": [
            {
                "type": "AAD",
                "audience": {
                    "type": "AzureADMyOrg",
                    "tenant_id": "37cd273a-1cec-4aae-a297-41480ea54f8d"
                }
            }
        ]
    }
```

As you can see in this example, your app specific package should appear in the config data :  **com.amf.pocsecured**
<br/>Copy this file in order to add it to your Android project. But before adding it, you will have to add this line : 

```json
    "account_mode" : "SINGLE"
```

Here is the final version of your config file : 


```json
    {
        "client_id": "6f483c01-4f04-4393-89ef-b07939462101",
        "authorization_user_agent": "DEFAULT",
        "redirect_uri": "msauth://com.amf.pocsecured/q%2BPiRqOdRzucqQyP%2FOcnNoHD5tg%3D",
        "account_mode" : "SINGLE"
        "authorities": [
            {
                "type": "AAD",
                "audience": {
                    "type": "AzureADMyOrg",
                    "tenant_id": "37cd273a-1cec-4aae-a297-41480ea54f8d"
                }
            }
        ]
    }
```

Now you can add this file into your project, in the 'raw' directory of your app's resources : 

```json
    ~projectRoot/app/src/main/res/raw/auth_config_single_account.json
```

### Add MSAL dependency

The next step is to add the MSAL specific dependency to your Android app. <br/>You will do it using gradle. Add this line to your application 'build.gradle' file :

```groovy
    implementation "com.microsoft.identity.client:msal:2.+"
```

This line will download and add the MSAL library module to your project dependencies.


### Implement authentication using MSAL Library

#### Update Manifest

First you need to declare the BrowerTabActivity used by the library for the explicit authentication.
As any other Android Activity, you must add it in you app's Manifest : 


```groovy
<activity android:name="com.microsoft.identity.client.BrowserTabActivity">
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />

        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />

        <data
            android:host="com.amf.pocsecured"
            android:path="/q+PiRqOdRzucqQyP/OcnNoHD5tg="
            android:scheme="msauth" />
    </intent-filter>
</activity>
```

As you can see in this example, 2 fields must be configured for your specific app:

1. **android:host** : App's package name
2. **android:path** : Signature Hash used to register the app to Azure Portal

#### Implement MicrosoftLoginHelper

Now let's start implementing the MSAL authentications methods. We will focus here on 3 features : Library initialization, sign-in and sign-out.

All these feature must be asynchronously, so we will use in this example RxJava.

First you must initialize the MSAL library. This operation will be done by calling this method :

```groovy
PublicClientApplication.createSingleAccountPublicClientApplication(context, R.raw.auth_config_single_account_v3, new IPublicClientApplication.ISingleAccountApplicationCreatedListener()
		{
			@Override
			public void onCreated(ISingleAccountPublicClientApplication application)
			{
			    ...
			}

			@Override
			public void onError(MsalException exception)
			{
			    ...
			}
		})
```

As you can see this method takes 3 params : 

1. **Context context** : Android context
2. **int configFileResourceId** : resource id for the JSON config file we generated previously
3. **ISingleAccountApplicationCreatedListener listener** : Listener called by MSAL library with init result

If the init is successful, a **ISingleAccountPublicClientApplication** object will be returned in the **onCreated** callback.
This object will allow you to perform the signin and signout operations.

Once this init operation is done, you can check if a user was previsouly signed in and eventually retrieve its informations :


```groovy
PublicClientApplication.createSingleAccountPublicClientApplication(context, R.raw.auth_config_single_account_v3, new IPublicClientApplication.ISingleAccountApplicationCreatedListener()
		{
			@Override
			public void onCreated(ISingleAccountPublicClientApplication application)
			{
    			/*
    			 * save reference to ISingleAccountPublicClientApplication for further use
    			 */
				mSingleAccountApp = application;
				if (mSingleAccountApp == null)
				{
        			/*
        			 * Init failed
        			 */
					emitter.onNext(false);
					emitter.onComplete();
				}


    			/*
    			 * Here we check if a user was previsouly gined in
    			 */
				mSingleAccountApp.getCurrentAccountAsync(new ISingleAccountPublicClientApplication.CurrentAccountCallback()
				{
					@Override
					public void onAccountLoaded(@Nullable IAccount activeAccount)
					{
						if (activeAccount != null)
						{
                			/*
                			 * A user was indeed previsouly signed in.
                			 * Now we must retrieve its access token
                			 */
							mAccount = activeAccount;
							mSingleAccountApp.acquireTokenSilentAsync(SCOPES, mAccount.getAuthority(), new SilentAuthenticationCallback()
							{

								@Override
								public void onSuccess(IAuthenticationResult authenticationResult)
								{
									Timber.d("Successfully authenticated");
								    Timber.d("ID Token: %s", Objects.requireNonNull(authenticationResult.getAccount().getClaims()).get("id_token"));
									mAuthResult = authenticationResult;
									mAccount = authenticationResult.getAccount();
									emitter.onNext(true);
									emitter.onComplete();
								}

								@Override
								public void onError(MsalException exception)
								{
								    ...
								}
							});
						}
						else
						{
							emitter.onNext(true);
							emitter.onComplete();
						}
					}

					@Override
					public void onAccountChanged(@Nullable IAccount priorAccount, @Nullable IAccount currentAccount)
					{
					}

					@Override
					public void onError(@NonNull MsalException exception)
					{
						emitter.onError(exception);
					}
				});
			}

			@Override
			public void onError(MsalException exception)
			{
			    ...
			}
		})
```

As you can see in this example, 2 MSAL methods were used :

* **getCurrentAccountAsync()** : Gets the current account and notify if the current account changes.
* **acquireTokenSilentAsync()** : If the current account is not null, acquires the access token withtout launching the explicit authent screen. This method takes a specific parameter called 'SCOPES', it is the list of actions allowed :

```groovy
private final static String[] SCOPES = {"User.Read", "Calendars.Read"};
```

In this example, we allow the app read user and calendar informations.

Next is the sign-in feature. Once the library is initialized and the **ISingleAccountPublicClientApplication** available, you can call the 

